#! /bin/sh
# $ReOpenLDAP$
## Copyright (c) 2015,2016 Leonid Yuriev <leo@yuriev.ru>.
## Copyright (c) 2015,2016 Peter-Service R&D LLC <http://billing.ru/>.
##
## This file is part of ReOpenLDAP.
##
## ReOpenLDAP is free software; you can redistribute it and/or modify it under
## the terms of the GNU Affero General Public License as published by
## the Free Software Foundation; either version 3 of the License, or
## (at your option) any later version.
##
## ReOpenLDAP is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU Affero General Public License for more details.
##
## You should have received a copy of the GNU Affero General Public License
## along with this program.  If not, see <http://www.gnu.org/licenses/>.
##
## ---
##
## Copyright 1998-2014 The OpenLDAP Foundation.
## All rights reserved.
##
## Redistribution and use in source and binary forms, with or without
## modification, are permitted only as authorized by the OpenLDAP
## Public License.
##
## A copy of this license is available in the file LICENSE in the
## top-level directory of the distribution or, alternatively, at
## <http://www.OpenLDAP.org/license.html>.
#
# Make a release
#

#
# This script MUST NOT add files to the export nor modify
# any file in the export, exceptions:
#	make guide.html
#

set -e 		# exit immediately if any errors occur

if test $# != 3 ; then
	echo 'usage: mkrelease REPO RELNAME TAG'
	exit 1
fi

REPO=$1
shift
RELNAME=openldap-$1
shift
TAG=$1
shift

#Linux
#SHA="sha1sum"
#MD="md5sum"
#BSD
#SHA="sha1"
#MD="md5"
#OpenSSL
SHA="openssl sha1"
MD="openssl md5"

if test -e $RELNAME ; then
	echo "error: $RELNAME exists"
	exit 1
fi

echo Release: $RELNAME
echo Tag: $TAG

git archive --format=tar --prefix="${RELNAME}/" --remote="${REPO}" "$TAG" |  tar xvf -

if test ! -d $RELNAME ; then
	echo "error: $RELNAME doesn't exists"
	exit 1
fi

if test -e $RELNAME/doc/guide/admin/guide.sdf ; then
	echo "build guide..."
	( cd $RELNAME/doc/guide/admin ; make guide.html )
else
	echo "No guide"
fi

if test -e $RELNAME/libraries/liblunicode/ucdata/uctable.h ; then
	echo "touching uctable.h..."
	touch $RELNAME/libraries/liblunicode/ucdata/uctable.h
fi

if test ! -e $RELNAME/build/version.sh ; then
	echo "No build version"
	OL_STRING="something"
else
	eval `$RELNAME/build/version.sh`
fi

echo "Rolling up $OL_STRING ..."


tar cf $RELNAME.tar $RELNAME
gzip -9 -c $RELNAME.tar > $RELNAME.tgz
${MD} $RELNAME.tgz > $RELNAME.md5
${SHA} $RELNAME.tgz > $RELNAME.sha1
rm -f $RELNAME.tar

ls -l $RELNAME.*

echo "Made $OL_STRING as $RELNAME.tgz"

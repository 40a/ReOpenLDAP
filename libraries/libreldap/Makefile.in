# Makefile.in for LDAP -lldap
# $ReOpenLDAP$
## Copyright (c) 2015,2016 Leonid Yuriev <leo@yuriev.ru>.
## Copyright (c) 2015,2016 Peter-Service R&D LLC <http://billing.ru/>.
##
## This file is part of ReOpenLDAP.
##
## ReOpenLDAP is free software; you can redistribute it and/or modify it under
## the terms of the GNU Affero General Public License as published by
## the Free Software Foundation; either version 3 of the License, or
## (at your option) any later version.
##
## ReOpenLDAP is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU Affero General Public License for more details.
##
## You should have received a copy of the GNU Affero General Public License
## along with this program.  If not, see <http://www.gnu.org/licenses/>.
##
## ---
##
## Copyright 1998-2014 The OpenLDAP Foundation.
## All rights reserved.
##
## Redistribution and use in source and binary forms, with or without
## modification, are permitted only as authorized by the OpenLDAP
## Public License.
##
## A copy of this license is available in the file LICENSE in the
## top-level directory of the distribution or, alternatively, at
## <http://www.OpenLDAP.org/license.html>.

LIBRARY = libreldap.la

PROGRAMS= $(addprefix test/, \
	apitest dntest dtest etest ftest idtest test urltest \
	avltest tavltest )
# BROKEN: ptest

SRCS	= abandon.c add.c addentry.c assertion.c bind.c bprint.c \
	cancel.c charray.c compare.c controls.c cyrus.c dds.c debug.c \
	decode.c delete.c deref.c dnssrv.c encode.c error.c extended.c \
	fetch.c filter.c free.c getattr.c getdn.c getentry.c \
	getvalues.c gssapi.c hipagut.c init.c io.c lber_options.c \
	ldap_options.c ldap_sync.c ldif.c memory.c messages.c modify.c \
	modrdn.c open.c os-ip.c os-local.c pagectrl.c passwd.c posix.c \
	ppolicy.c print.c references.c request.c result.c rmutex.c rq.c \
	sasl.c sbind.c schema.c search.c sockbuf.c sort.c sortctrl.c \
	stctrl.c stdio.c string.c t61.c threads.c tls2.c tls_g.c \
	tls_m.c tls_o.c tpool.c turn.c txn.c unbind.c url.c utf-8.c \
	utf-8-conv.c util-int.c vlvctrl.c whoami.c

XSRCS	= version.c

OBJS	= $(SRCS:.c=.lo)

LDAP_INCDIR= ../../include
LDAP_LIBDIR= ../../libraries

LIB_DEFS = -DRELDAP_LIBRARY -DLDAP_R_COMPILE
XDEFS = -DLDAP_R_COMPILE

XLIBS = $(LIBRARY) $(LDAP_LIBLUTIL_A)
XXLIBS = $(SECURITY_LIBS) $(LUTIL_LIBS)
XXXLIBS = $(LTHREAD_LIBS)
NEED_LIBS = $(AC_LIBS) $(LUTIL_LIBS) $(SECURITY_LIBS) $(LTHREAD_LIBS)

# LY: here is an extra $(LIBRARY) at the end,
#     it is the easiest workaround to resolve
#     mutual references between libreldap and liblutil.
$(PROGRAMS): test/%: test/%.o $(XLIBS)
	$(LTLINK) -o $@ $< $(LIBS) $(LIBRARY)

CFFILES=ldap.conf

install-local: $(CFFILES) FORCE
	-$(MKDIR) $(DESTDIR)$(libdir)
	$(LTINSTALL) $(INSTALLFLAGS) -m 644 $(LIBRARY) $(DESTDIR)$(libdir)
	$(LTFINISH) $(DESTDIR)$(libdir)
	-$(MKDIR) $(DESTDIR)$(sysconfdir)
	@for i in $(CFFILES); do \
		if test ! -f $(DESTDIR)$(sysconfdir)/$$i; then \
			echo "installing $$i in $(sysconfdir)"; \
			echo "$(INSTALL) $(INSTALLFLAGS) -m 644  $(srcdir)/$$i $(DESTDIR)$(sysconfdir)/$$i"; \
			$(INSTALL) $(INSTALLFLAGS) -m 644 $(srcdir)/$$i $(DESTDIR)$(sysconfdir)/$$i; \
		else \
			echo "PRESERVING EXISTING CONFIGURATION FILE $(sysconfdir)/$$i" ; \
		fi; \
		$(INSTALL) $(INSTALLFLAGS) -m 644 $(srcdir)/$$i $(DESTDIR)$(sysconfdir)/$$i.default; \
	done
